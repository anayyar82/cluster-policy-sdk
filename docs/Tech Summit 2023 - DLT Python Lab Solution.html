[SQL_GET_CARD_USAGE_SNAPSHOT_DATE]
select max(de12_txn_date) as snapshot_date from ${TBL_SRC_CUTC}

[SQL_STEP_M0_PREPARE_LOOKING_DATE_TO_ROLLING]

CREATE TABLE ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_0_LOOKUP_DATE_MONTHLY}'
AS
SELECT
to_date(hierarchy_date) AS de12_txn_date
,CASE
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),-2),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),-3)  THEN -3
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),-1),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),-2)  THEN -2
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),0),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),-1)  THEN -1
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),1),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),0)  THEN 01
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),2),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),1)  THEN 02
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),3),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),2)  THEN 03
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),4),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),3)  THEN 04
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),5),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),4)  THEN 05
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),6),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),5)  THEN 06
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),7),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),6)  THEN 07
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),7)  THEN 08
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),9),1)  AND months_sub(to_date('${SNAPSHOT_DATE}'),8)  THEN 09
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),10),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),9)  THEN 10
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),11),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),10) THEN 11
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),12),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),11) THEN 12
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),13),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),12) THEN 13
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),14),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),13) THEN 14
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),15),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),14) THEN 15
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),15) THEN 16
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),17),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),16) THEN 17
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),18),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),17) THEN 18
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),19),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),18) THEN 19
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),20),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),19) THEN 20
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),21),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),20) THEN 21
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),22),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),21) THEN 22
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),23),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),22) THEN 23
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),24),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),23) THEN 24
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),25),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),24) THEN 25
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),26),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),25) THEN 26
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),27),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),26) THEN 27
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),28),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),27) THEN 28
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),29),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),28) THEN 29
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),30),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),29) THEN 30
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),31),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),30) THEN 31
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),32),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),31) THEN 32
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),33),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),32) THEN 33
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),34),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),33) THEN 34
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),35),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),34) THEN 35
    WHEN to_date(hierarchy_date) BETWEEN days_add(months_sub(to_date('${SNAPSHOT_DATE}'),36),1) AND months_sub(to_date('${SNAPSHOT_DATE}'),35) THEN 36
END AS rolling_month
FROM ${TBL_SRC_PERIOD}
where level_name='Day'
AND to_date(hierarchy_date)<=months_add(to_date('${SNAPSHOT_DATE}'), 3)
AND to_date(hierarchy_date) >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),24),1)
;


[SQL_STEP_M0B_LOOKUP_LOCID_TO_MMHID]

CREATE TABLE ${DB_NAME}.${TBL_0B_MMHID_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_0B_MMHID_MONTHLY}'
AS
    SELECT old_loc_id,merchant_market_hierarchy_id AS mmh_id, cleansed_country_code AS merchant_country
    FROM ${TBL_SRC_LOCATION}
    WHERE '${SERVE_OR_TRAIN}'='serve'
        AND cleansed_country_code IN ${COUNTRY_CD}
UNION
    SELECT old_loc_id,merchant_market_hierarchy_id AS mmh_id, cleansed_country_code AS merchant_country
    FROM ${TBL_SRC_LOCATION_HIST}
    WHERE dw_process_date=
                            (
                                SELECT max(dw_process_date)
                                FROM ${TBL_SRC_LOCATION_HIST}
                                WHERE dw_process_date<=to_date('${SNAPSHOT_DATE}')
                                AND dw_process_date>=months_sub(to_date('${SNAPSHOT_DATE}'),3)
                              )

        AND cleansed_country_code IN ${COUNTRY_CD}
    AND '${SERVE_OR_TRAIN}'='train'
;

[SQL_STEP_M1A_PREPARE_CUT_CLEAR_DATA_PART1]

CREATE TABLE ${DB_NAME}.${TBL_1A_DATA_MONTHLY_PART1}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1A_DATA_MONTHLY_PART1}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,T3.rolling_month

,SUM(t1.txn_cnt) AS txn_cnt
,SUM(t1.txn_amt) AS txn_amt

,SUM(paypass_cnt) AS paypass_cnt
,SUM(chp_cnt) AS chp_cnt
,SUM(chnp_cnt) AS chnp_cnt
,SUM(cp_cnt) AS cp_cnt
,SUM(cnp_cnt) AS cnp_cnt
,SUM(recurring_cnt) AS recurring_cnt
,SUM(online_cnt) AS online_cnt
,SUM(tokenized_cnt) AS tokenized_cnt
,SUM(cash_cnt) AS cash_cnt
,SUM(reversed_cnt) AS reversed_cnt

,SUM(paypass_amt) AS paypass_amt
,SUM(chp_amt) AS chp_amt
,SUM(chnp_amt) AS chnp_amt
,SUM(cp_amt) AS cp_amt
,SUM(cnp_amt) AS cnp_amt
,SUM(recurring_amt) AS recurring_amt
,SUM(online_amt) AS online_amt
,SUM(tokenized_amt) AS tokenized_amt
,SUM(cash_amt) AS cash_amt
,SUM(reversed_amt) AS reversed_amt

,SUM(CASE WHEN flag_business=1 THEN txn_cnt ELSE 0 END) AS small_business_cnt
,SUM(CASE WHEN flag_business=1 THEN txn_amt ELSE 0 END) AS small_business_amt

,SUM(CASE WHEN t2.merchant_country=dw_iss_country_cd THEN txn_cnt ELSE 0 END) AS dom_txn_cnt
,SUM(CASE WHEN t2.merchant_country=dw_iss_country_cd THEN txn_amt ELSE 0 END) AS dom_txn_amt

,SUM(CASE WHEN t2.merchant_country!=dw_iss_country_cd THEN txn_cnt ELSE 0 END) AS xborder_txn_cnt
,SUM(CASE WHEN t2.merchant_country!=dw_iss_country_cd THEN txn_amt ELSE 0 END) AS xborder_txn_amt

FROM ${TBL_SRC_CUTC} t1
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 on to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)
GROUP BY t2.mmh_id,T3.rolling_month
;


[SQL_STEP_M1A_PREPARE_CUT_CLEAR_DATA_PART2]

CREATE TABLE ${DB_NAME}.${TBL_1A_DATA_MONTHLY_PART2}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1A_DATA_MONTHLY_PART2}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,T3.rolling_month

,SUM(t1.txn_cnt) AS txn_cnt
,SUM(t1.txn_amt) AS txn_amt

,SUM(paypass_cnt) AS paypass_cnt
,SUM(chp_cnt) AS chp_cnt
,SUM(chnp_cnt) AS chnp_cnt
,SUM(cp_cnt) AS cp_cnt
,SUM(cnp_cnt) AS cnp_cnt
,SUM(recurring_cnt) AS recurring_cnt
,SUM(online_cnt) AS online_cnt
,SUM(tokenized_cnt) AS tokenized_cnt
,SUM(cash_cnt) AS cash_cnt
,SUM(reversed_cnt) AS reversed_cnt

,SUM(paypass_amt) AS paypass_amt
,SUM(chp_amt) AS chp_amt
,SUM(chnp_amt) AS chnp_amt
,SUM(cp_amt) AS cp_amt
,SUM(cnp_amt) AS cnp_amt
,SUM(recurring_amt) AS recurring_amt
,SUM(online_amt) AS online_amt
,SUM(tokenized_amt) AS tokenized_amt
,SUM(cash_amt) AS cash_amt
,SUM(reversed_amt) AS reversed_amt

,SUM(CASE WHEN flag_business=1 THEN txn_cnt ELSE 0 END) AS small_business_cnt
,SUM(CASE WHEN flag_business=1 THEN txn_amt ELSE 0 END) AS small_business_amt

,SUM(CASE WHEN t2.merchant_country=dw_iss_country_cd THEN txn_cnt ELSE 0 END) AS dom_txn_cnt
,SUM(CASE WHEN t2.merchant_country=dw_iss_country_cd THEN txn_amt ELSE 0 END) AS dom_txn_amt

,SUM(CASE WHEN t2.merchant_country!=dw_iss_country_cd THEN txn_cnt ELSE 0 END) AS xborder_txn_cnt
,SUM(CASE WHEN t2.merchant_country!=dw_iss_country_cd THEN txn_amt ELSE 0 END) AS xborder_txn_amt

FROM ${TBL_SRC_CUTC} t1
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 on to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1)
AND t1.de12_txn_date < days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)
GROUP BY t2.mmh_id,T3.rolling_month
;

[SQL_STEP_M1A_PREPARE_CUT_CLEAR_DATA_PART3]

CREATE TABLE ${DB_NAME}.${TBL_1A_DATA_MONTHLY_PART3}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1A_DATA_MONTHLY_PART3}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,T3.rolling_month

,SUM(t1.txn_cnt) AS txn_cnt
,SUM(t1.txn_amt) AS txn_amt

,SUM(paypass_cnt) AS paypass_cnt
,SUM(chp_cnt) AS chp_cnt
,SUM(chnp_cnt) AS chnp_cnt
,SUM(cp_cnt) AS cp_cnt
,SUM(cnp_cnt) AS cnp_cnt
,SUM(recurring_cnt) AS recurring_cnt
,SUM(online_cnt) AS online_cnt
,SUM(tokenized_cnt) AS tokenized_cnt
,SUM(cash_cnt) AS cash_cnt
,SUM(reversed_cnt) AS reversed_cnt

,SUM(paypass_amt) AS paypass_amt
,SUM(chp_amt) AS chp_amt
,SUM(chnp_amt) AS chnp_amt
,SUM(cp_amt) AS cp_amt
,SUM(cnp_amt) AS cnp_amt
,SUM(recurring_amt) AS recurring_amt
,SUM(online_amt) AS online_amt
,SUM(tokenized_amt) AS tokenized_amt
,SUM(cash_amt) AS cash_amt
,SUM(reversed_amt) AS reversed_amt

,SUM(CASE WHEN flag_business=1 THEN txn_cnt ELSE 0 END) AS small_business_cnt
,SUM(CASE WHEN flag_business=1 THEN txn_amt ELSE 0 END) AS small_business_amt

,SUM(CASE WHEN t2.merchant_country=dw_iss_country_cd THEN txn_cnt ELSE 0 END) AS dom_txn_cnt
,SUM(CASE WHEN t2.merchant_country=dw_iss_country_cd THEN txn_amt ELSE 0 END) AS dom_txn_amt

,SUM(CASE WHEN t2.merchant_country!=dw_iss_country_cd THEN txn_cnt ELSE 0 END) AS xborder_txn_cnt
,SUM(CASE WHEN t2.merchant_country!=dw_iss_country_cd THEN txn_amt ELSE 0 END) AS xborder_txn_amt

FROM ${TBL_SRC_CUTC} t1
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 on to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),24),1)
AND t1.de12_txn_date < days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1)
GROUP BY t2.mmh_id,T3.rolling_month
;


[SQL_STEP_M1A_PREPARE_CUT_CLEAR_DATA_FINAL]

CREATE TABLE ${DB_NAME}.${TBL_1A_DATA_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1A_DATA_MONTHLY}'
AS
WITH temp1 AS
(	select * from ${DB_NAME}.${TBL_1A_DATA_MONTHLY_PART1} UNION
	select * from ${DB_NAME}.${TBL_1A_DATA_MONTHLY_PART2} UNION
	select * from ${DB_NAME}.${TBL_1A_DATA_MONTHLY_PART3}
)
SELECT
mmh_id
,rolling_month

,SUM(txn_cnt) AS txn_cnt
,SUM(txn_amt) AS txn_amt

,SUM(paypass_cnt) AS paypass_cnt
,SUM(chp_cnt) AS chp_cnt
,SUM(chnp_cnt) AS chnp_cnt
,SUM(cp_cnt) AS cp_cnt
,SUM(cnp_cnt) AS cnp_cnt
,SUM(recurring_cnt) AS recurring_cnt
,SUM(online_cnt) AS online_cnt
,SUM(tokenized_cnt) AS tokenized_cnt
,SUM(cash_cnt) AS cash_cnt
,SUM(reversed_cnt) AS reversed_cnt

,SUM(paypass_amt) AS paypass_amt
,SUM(chp_amt) AS chp_amt
,SUM(chnp_amt) AS chnp_amt
,SUM(cp_amt) AS cp_amt
,SUM(cnp_amt) AS cnp_amt
,SUM(recurring_amt) AS recurring_amt
,SUM(online_amt) AS online_amt
,SUM(tokenized_amt) AS tokenized_amt
,SUM(cash_amt) AS cash_amt
,SUM(reversed_amt) AS reversed_amt

,SUM(small_business_cnt) AS small_business_cnt ,SUM(small_business_amt) AS small_business_amt
,SUM(dom_txn_cnt) AS dom_txn_cnt ,SUM(dom_txn_amt) AS dom_txn_amt
,SUM(xborder_txn_cnt) AS xborder_txn_cnt ,SUM(xborder_txn_amt) AS xborder_txn_amt

FROM temp1
GROUP BY mmh_id,rolling_month
;


[SQL_STEP_M1B_PREPARE_AUTH_DEBIT_FRAUD_DATA]

CREATE TABLE ${DB_NAME}.${TBL_1B_AUTH_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1B_AUTH_MONTHLY}'
AS

SELECT STRAIGHT_JOIN
t2.mmh_id
,T3.rolling_month

,SUM(t1.approved_cnt) AS approved_cnt
,SUM(t1.approved_amt) AS approved_amt

,SUM(t1.declined_cnt) AS declined_cnt
,SUM(t1.declined_amt) AS declined_amt

FROM ${TBL_SRC_FRAUD} t1
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
GROUP BY t2.mmh_id,T3.rolling_month
;


[SQL_STEP_M1C_PREPARE_CHARGEBACK_DATA]

CREATE TABLE ${DB_NAME}.${TBL_1C_CHARGEBACK_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1C_CHARGEBACK_MONTHLY}'
AS

SELECT STRAIGHT_JOIN
t2.mmh_id
,T3.rolling_month

,SUM(t1.tot_chargeback_cnt) AS tot_chargeback_cnt
,SUM(t1.tot_chargeback_amt) AS tot_chargeback_amt

,SUM(t1.first_chargeback_cnt) AS first_chargeback_cnt
,SUM(t1.first_chargeback_amt) AS first_chargeback_amt

,SUM(t1.representment_chargeback_cnt) AS representment_chargeback_cnt
,SUM(t1.representment_chargeback_amt) AS representment_chargeback_amt

,SUM(t1.arbitration_chargeback_cnt) AS arbitration_chargeback_cnt
,SUM(t1.arbitration_chargeback_amt) AS arbitration_chargeback_amt

,SUM(t1.fraud_chargeback_cnt) AS fraud_chargeback_cnt
,SUM(t1.fraud_chargeback_amt) AS fraud_chargeback_amt

,SUM(t1.cardholder_disputed_chargeback_cnt) AS cardholder_disputed_chargeback_cnt
,SUM(t1.cardholder_disputed_chargeback_amt) AS cardholder_disputed_chargeback_amt

FROM ${TBL_SRC_CHARGEBACK} t1
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
GROUP BY t2.mmh_id,T3.rolling_month
;


[SQL_STEP_M1D_PREPARE_ACCT_MMHID_DATA_PART1]

CREATE TABLE ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY_PART1}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1D_ACCTMMHID_MONTHLY_PART1}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,t1.account_number
,T3.rolling_month
,SUM(total_cnt) AS total_cnt
,SUM(reversed_cnt) AS reversed_cnt
,SUM(online_cnt) AS online_cnt
,SUM(recurring_cnt) AS recurring_cnt
FROM ${TBL_SRC_HIST_CUTC} t1
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)
GROUP BY t2.mmh_id,T3.rolling_month,t1.account_number
;


[SQL_STEP_M1D_PREPARE_ACCT_MMHID_DATA_PART2]

CREATE TABLE ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY_PART2}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1D_ACCTMMHID_MONTHLY_PART2}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,t1.account_number
,T3.rolling_month
,SUM(total_cnt) AS total_cnt
,SUM(reversed_cnt) AS reversed_cnt
,SUM(online_cnt) AS online_cnt
,SUM(recurring_cnt) AS recurring_cnt
FROM ${TBL_SRC_HIST_CUTC} t1
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1)
AND t1.de12_txn_date < days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)
GROUP BY t2.mmh_id,T3.rolling_month,t1.account_number
;


[SQL_STEP_M1D_PREPARE_ACCT_MMHID_DATA_PART3]

CREATE TABLE ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY_PART3}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1D_ACCTMMHID_MONTHLY_PART3}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,t1.account_number
,T3.rolling_month
,SUM(total_cnt) AS total_cnt
,SUM(reversed_cnt) AS reversed_cnt
,SUM(online_cnt) AS online_cnt
,SUM(recurring_cnt) AS recurring_cnt
FROM ${TBL_SRC_HIST_CUTC} t1
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),24),1)
AND t1.de12_txn_date < days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1)
GROUP BY t2.mmh_id,T3.rolling_month,t1.account_number
;


[SQL_STEP_M1D_PREPARE_ACCT_MMHID_DATA_FINAL]

CREATE TABLE ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1D_ACCTMMHID_MONTHLY}'
AS
WITH temp1 AS
(	select * from ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY_PART1} UNION
	select * from ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY_PART2} UNION
	select * from ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY_PART3}
)
SELECT STRAIGHT_JOIN
mmh_id
,account_number
,rolling_month
,SUM(total_cnt) AS total_cnt
,SUM(reversed_cnt) AS reversed_cnt
,SUM(online_cnt) AS online_cnt
,SUM(recurring_cnt) AS recurring_cnt
FROM temp1
GROUP BY mmh_id,rolling_month,account_number
;

[SQL_STEP_M1E_PREPARE_ACCT_AUTH_DATA_PART1]

CREATE TABLE ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART1}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART1}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,t1.account_number
,T3.rolling_month
,SUM(total_declined_cnt) AS total_declined_cnt
,SUM(total_approved_cnt) AS total_approved_cnt
FROM ${TBL_SRC_ACCT_AUTH_DEBIT} t1
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)
GROUP BY t2.mmh_id,T3.rolling_month,t1.account_number
;

[SQL_STEP_M1E_PREPARE_ACCT_AUTH_DATA_PART2]

CREATE TABLE ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART2}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART2}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,t1.account_number
,T3.rolling_month
,SUM(total_declined_cnt) AS total_declined_cnt
,SUM(total_approved_cnt) AS total_approved_cnt
FROM ${TBL_SRC_ACCT_AUTH_DEBIT} t1
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1)
AND t1.de12_txn_date < days_add(months_sub(to_date('${SNAPSHOT_DATE}'),8),1)
GROUP BY t2.mmh_id,T3.rolling_month,t1.account_number
;

[SQL_STEP_M1E_PREPARE_ACCT_AUTH_DATA_PART3]

CREATE TABLE ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART3}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART3}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,t1.account_number
,T3.rolling_month
,SUM(total_declined_cnt) AS total_declined_cnt
,SUM(total_approved_cnt) AS total_approved_cnt
FROM ${TBL_SRC_ACCT_AUTH_DEBIT} t1
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
INNER JOIN [BROADCAST] ${DB_NAME}.${TBL_0_LOOKUP_DATE_MONTHLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
WHERE t1.de12_txn_date >= days_add(months_sub(to_date('${SNAPSHOT_DATE}'),24),1)
AND t1.de12_txn_date < days_add(months_sub(to_date('${SNAPSHOT_DATE}'),16),1)
GROUP BY t2.mmh_id,T3.rolling_month,t1.account_number
;

[SQL_STEP_M1E_PREPARE_ACCT_AUTH_DATA_FINAL]

CREATE TABLE ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1E_ACCT_AUTH_DATA_MONTHLY}'
AS
WITH temp1 AS
(	select * from ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART1} UNION
	select * from ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART2} UNION
	select * from ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY_PART3}
)
SELECT STRAIGHT_JOIN
mmh_id
,account_number
,rolling_month
,SUM(total_declined_cnt) AS total_declined_cnt
,SUM(total_approved_cnt) AS total_approved_cnt
FROM temp1
GROUP BY mmh_id,rolling_month,account_number
;

[SQL_STEP_M2_PREPARE_DISTINCT_MERCHANTS]

CREATE TABLE ${DB_NAME}.${TBL_2_MERCHANTS_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_2_MERCHANTS_MONTHLY}'
AS
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1A_DATA_MONTHLY}
where rolling_month > 0
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1B_AUTH_MONTHLY}
where rolling_month > 0
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1C_CHARGEBACK_MONTHLY}
where rolling_month > 0
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY}
where rolling_month > 0
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY}
where rolling_month > 0
;


[SQL_STEP_M3_ROLLING_MONTHS_TABLE]

CREATE TABLE ${DB_NAME}.${TBL_3_ROLLING_MONTH}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_3_ROLLING_MONTH}'
AS

WITH nbrs1 AS
(
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1
)
,nbrs2 AS
(
    SELECT 1 AS n FROM nbrs1 CROSS JOIN nbrs1 AS b
)
,nbrs AS
(
    SELECT (ROW_NUMBER() OVER (ORDER BY n)) - 4  AS rolling_month
    FROM nbrs2
)
SELECT rolling_month AS rolling_month
FROM nbrs
WHERE rolling_month<=24 AND rolling_month!=0;
;


[SQL_STEP_M4_PREPARE_MMHIDS_ROLLINGMONTHS]

CREATE TABLE ${DB_NAME}.${TBL_4_MMHID_TO_ROLLING_MONTH}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_4_MMHID_TO_ROLLING_MONTH}'
AS
SELECT
t1.mmh_id
,t2.rolling_month
FROM ${DB_NAME}.${TBL_2_MERCHANTS_MONTHLY} t1
cross join ${DB_NAME}.${TBL_3_ROLLING_MONTH} t2
;


[SQL_STEP_M5_ROW_EXPLODE_CUT_CLEAR_DATA]

CREATE TABLE ${DB_NAME}.${TBL_5_EXPLODE_MONTHLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_5_EXPLODE_MONTHLY}'
AS
 WITH postal AS
(
        SELECT merchant_market_hierarchy_id AS mmh_id, cleansed_merchant_postal_code AS postal_code, industry
        ,ROW_NUMBER() OVER (PARTITION BY merchant_market_hierarchy_id ORDER BY merchant_market_hierarchy_id)  AS row_id
        FROM ${TBL_SRC_LOCATION_HIST}
        WHERE dw_process_date= (
                                SELECT max(dw_process_date)
                                FROM ${TBL_SRC_LOCATION_HIST}
                                WHERE dw_process_date<=to_date('${SNAPSHOT_DATE}')
                                AND dw_process_date>=months_sub(to_date('${SNAPSHOT_DATE}'),3)
                              )
),
MerchantCountry AS
(
    SELECT mmh_id,merchant_country,ROW_NUMBER() OVER (PARTITION BY mmh_id ORDER BY mmh_id) AS row_id
    FROM ${DB_NAME}.${TBL_0B_MMHID_MONTHLY}
)
SELECT STRAIGHT_JOIN
 t1.mmh_id
,t1.rolling_month

,to_date('${SNAPSHOT_DATE}')  AS txn_snapshot_date
,mcon.merchant_country

,COALESCE(t2.txn_amt,0) AS txn_amt
,COALESCE(t2.txn_cnt,0) AS txn_cnt

,COALESCE(T2.paypass_cnt,0) AS paypass_cnt
,COALESCE(t2.chp_cnt,0) AS chp_cnt
,COALESCE(t2.chnp_cnt,0) AS chnp_cnt
,COALESCE(t2.cp_cnt,0) AS cp_cnt
,COALESCE(t2.cnp_cnt,0) AS cnp_cnt
,COALESCE(t2.recurring_cnt,0) AS recurring_cnt
,COALESCE(t2.online_cnt,0) AS online_cnt
,COALESCE(t2.tokenized_cnt,0) AS tokenized_cnt
,COALESCE(t2.cash_cnt,0) AS cash_cnt
,COALESCE(t2.reversed_cnt,0) AS reversed_cnt

,COALESCE(T2.paypass_amt,0) AS paypass_amt
,COALESCE(t2.chp_amt,0) AS chp_amt
,COALESCE(t2.chnp_amt,0) AS chnp_amt
,COALESCE(t2.cp_amt,0) AS cp_amt
,COALESCE(t2.cnp_amt,0) AS cnp_amt
,COALESCE(t2.recurring_amt,0) AS recurring_amt
,COALESCE(t2.online_amt,0) AS online_amt
,COALESCE(t2.tokenized_amt,0) AS tokenized_amt
,COALESCE(t2.cash_amt,0) AS cash_amt
,COALESCE(t2.reversed_amt,0) AS reversed_amt

,COALESCE(t2.small_business_cnt,0) AS small_business_cnt
,COALESCE(t2.small_business_amt,0) AS small_business_amt

,COALESCE(t2.dom_txn_cnt,0) AS dom_txn_cnt
,COALESCE(t2.dom_txn_amt,0) AS dom_txn_amt

,COALESCE(t2.xborder_txn_cnt,0) AS xborder_txn_cnt
,COALESCE(t2.xborder_txn_amt,0) AS xborder_txn_amt

,COALESCE(t3.approved_cnt,0) AS approved_cnt
,COALESCE(t3.approved_amt,0) AS approved_amt
,COALESCE(t3.declined_cnt,0) AS declined_cnt
,COALESCE(t3.declined_amt,0) AS declined_amt

,COALESCE(t4.tot_chargeback_cnt,0) AS tot_chargeback_cnt
,COALESCE(t4.tot_chargeback_amt,0) AS tot_chargeback_amt
,COALESCE(t4.first_chargeback_cnt,0) AS first_chargeback_cnt
,COALESCE(t4.first_chargeback_amt,0) AS first_chargeback_amt
,COALESCE(t4.representment_chargeback_cnt,0) AS representment_chargeback_cnt
,COALESCE(t4.representment_chargeback_amt,0) AS representment_chargeback_amt
,COALESCE(t4.arbitration_chargeback_cnt,0) AS arbitration_chargeback_cnt
,COALESCE(t4.arbitration_chargeback_amt,0) AS arbitration_chargeback_amt
,COALESCE(t4.fraud_chargeback_cnt,0) AS fraud_chargeback_cnt
,COALESCE(t4.fraud_chargeback_amt,0) AS fraud_chargeback_amt
,COALESCE(t4.cardholder_disputed_chargeback_cnt,0) AS cardholder_disputed_chargeback_cnt
,COALESCE(t4.cardholder_disputed_chargeback_amt,0) AS cardholder_disputed_chargeback_amt

,pos.postal_code
,UPPER(COALESCE(pos.industry,'N/A')) AS industry
,UPPER(COALESCE(supind.super_industry,'N/A')) AS super_industry

FROM ${DB_NAME}.${TBL_4_MMHID_TO_ROLLING_MONTH} t1
LEFT OUTER JOIN [SHUFFLE] ${DB_NAME}.${TBL_1A_DATA_MONTHLY} t2 ON t2.mmh_id = t1.mmh_id AND t2.rolling_month = t1.rolling_month
LEFT OUTER JOIN [SHUFFLE] ${DB_NAME}.${TBL_1B_AUTH_MONTHLY} t3 ON t3.mmh_id = t1.mmh_id AND t3.rolling_month = t1.rolling_month
LEFT OUTER JOIN [SHUFFLE] ${DB_NAME}.${TBL_1C_CHARGEBACK_MONTHLY} t4 ON t4.mmh_id = t1.mmh_id AND t4.rolling_month = t1.rolling_month
LEFT OUTER JOIN [BROADCAST] ${TBL_SRC_AGG_MERCH} supind ON supind.aggregate_merchant_id = t1.mmh_id
LEFT OUTER JOIN [SHUFFLE] postal pos ON pos.mmh_id = t1.mmh_id AND pos.row_id=1
LEFT OUTER JOIN [BROADCAST] MerchantCountry mcon ON mcon.mmh_id = t1.mmh_id AND mcon.row_id=1
;


[SQL_WEEKLY_0_PREPARE_LOOKUP_DATE_TO_ROLLING_PERIOD]

CREATE TABLE ${DB_NAME}.${TBL_0_LOOKUP_DATE_WEEKLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_0_LOOKUP_DATE_WEEKLY}'
AS
SELECT
to_date(hierarchy_date) AS de12_txn_date
,CASE
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -6) AND to_date('${SNAPSHOT_DATE}') THEN 01
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -13) AND days_add(to_date('${SNAPSHOT_DATE}'), -7) THEN 02
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -20) AND days_add(to_date('${SNAPSHOT_DATE}'), -14) THEN 03
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -27) AND days_add(to_date('${SNAPSHOT_DATE}'), -21) THEN 04
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -34) AND days_add(to_date('${SNAPSHOT_DATE}'), -28) THEN 05
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -41) AND days_add(to_date('${SNAPSHOT_DATE}'), -35) THEN 06
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -48) AND days_add(to_date('${SNAPSHOT_DATE}'), -42) THEN 07
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -55) AND days_add(to_date('${SNAPSHOT_DATE}'), -49) THEN 08
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -62) AND days_add(to_date('${SNAPSHOT_DATE}'), -56) THEN 09
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -69) AND days_add(to_date('${SNAPSHOT_DATE}'), -63) THEN 10
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -76) AND days_add(to_date('${SNAPSHOT_DATE}'), -70) THEN 11
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -83) AND days_add(to_date('${SNAPSHOT_DATE}'), -77) THEN 12
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -90) AND days_add(to_date('${SNAPSHOT_DATE}'), -84) THEN 13
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -97) AND days_add(to_date('${SNAPSHOT_DATE}'), -91) THEN 14
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -104) AND days_add(to_date('${SNAPSHOT_DATE}'), -98) THEN 15
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -111) AND days_add(to_date('${SNAPSHOT_DATE}'), -105) THEN 16
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -118) AND days_add(to_date('${SNAPSHOT_DATE}'), -112) THEN 17
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -125) AND days_add(to_date('${SNAPSHOT_DATE}'), -119) THEN 18
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -132) AND days_add(to_date('${SNAPSHOT_DATE}'), -126) THEN 19
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -139) AND days_add(to_date('${SNAPSHOT_DATE}'), -133) THEN 20
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -146) AND days_add(to_date('${SNAPSHOT_DATE}'), -140) THEN 21
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -153) AND days_add(to_date('${SNAPSHOT_DATE}'), -147) THEN 22
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -160) AND days_add(to_date('${SNAPSHOT_DATE}'), -154) THEN 23
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -167) AND days_add(to_date('${SNAPSHOT_DATE}'), -161) THEN 24
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -174) AND days_add(to_date('${SNAPSHOT_DATE}'), -168) THEN 25
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -181) AND days_add(to_date('${SNAPSHOT_DATE}'), -175) THEN 26
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -188) AND days_add(to_date('${SNAPSHOT_DATE}'), -182) THEN 27
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -195) AND days_add(to_date('${SNAPSHOT_DATE}'), -189) THEN 28
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -202) AND days_add(to_date('${SNAPSHOT_DATE}'), -196) THEN 29
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -209) AND days_add(to_date('${SNAPSHOT_DATE}'), -203) THEN 30
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -216) AND days_add(to_date('${SNAPSHOT_DATE}'), -210) THEN 31
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -223) AND days_add(to_date('${SNAPSHOT_DATE}'), -217) THEN 32
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -230) AND days_add(to_date('${SNAPSHOT_DATE}'), -224) THEN 33
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -237) AND days_add(to_date('${SNAPSHOT_DATE}'), -231) THEN 34
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -244) AND days_add(to_date('${SNAPSHOT_DATE}'), -238) THEN 35
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -251) AND days_add(to_date('${SNAPSHOT_DATE}'), -245) THEN 36
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -258) AND days_add(to_date('${SNAPSHOT_DATE}'), -252) THEN 37
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -265) AND days_add(to_date('${SNAPSHOT_DATE}'), -259) THEN 38
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -272) AND days_add(to_date('${SNAPSHOT_DATE}'), -266) THEN 39
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -279) AND days_add(to_date('${SNAPSHOT_DATE}'), -273) THEN 40
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -286) AND days_add(to_date('${SNAPSHOT_DATE}'), -280) THEN 41
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -293) AND days_add(to_date('${SNAPSHOT_DATE}'), -287) THEN 42
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -300) AND days_add(to_date('${SNAPSHOT_DATE}'), -294) THEN 43
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -307) AND days_add(to_date('${SNAPSHOT_DATE}'), -301) THEN 44
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -314) AND days_add(to_date('${SNAPSHOT_DATE}'), -308) THEN 45
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -321) AND days_add(to_date('${SNAPSHOT_DATE}'), -315) THEN 46
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -328) AND days_add(to_date('${SNAPSHOT_DATE}'), -322) THEN 47
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -335) AND days_add(to_date('${SNAPSHOT_DATE}'), -329) THEN 48
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -342) AND days_add(to_date('${SNAPSHOT_DATE}'), -336) THEN 49
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -349) AND days_add(to_date('${SNAPSHOT_DATE}'), -343) THEN 50
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -356) AND days_add(to_date('${SNAPSHOT_DATE}'), -350) THEN 51
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -363) AND days_add(to_date('${SNAPSHOT_DATE}'), -357) THEN 52
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -370) AND days_add(to_date('${SNAPSHOT_DATE}'), -364) THEN 53
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -377) AND days_add(to_date('${SNAPSHOT_DATE}'), -371) THEN 54
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -384) AND days_add(to_date('${SNAPSHOT_DATE}'), -378) THEN 55
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -391) AND days_add(to_date('${SNAPSHOT_DATE}'), -385) THEN 56
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -398) AND days_add(to_date('${SNAPSHOT_DATE}'), -392) THEN 57
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -405) AND days_add(to_date('${SNAPSHOT_DATE}'), -399) THEN 58
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -412) AND days_add(to_date('${SNAPSHOT_DATE}'), -406) THEN 59
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -419) AND days_add(to_date('${SNAPSHOT_DATE}'), -413) THEN 60
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -426) AND days_add(to_date('${SNAPSHOT_DATE}'), -420) THEN 61
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -433) AND days_add(to_date('${SNAPSHOT_DATE}'), -427) THEN 62
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -440) AND days_add(to_date('${SNAPSHOT_DATE}'), -434) THEN 63
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -447) AND days_add(to_date('${SNAPSHOT_DATE}'), -441) THEN 64
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -454) AND days_add(to_date('${SNAPSHOT_DATE}'), -448) THEN 65
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -461) AND days_add(to_date('${SNAPSHOT_DATE}'), -455) THEN 66
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -468) AND days_add(to_date('${SNAPSHOT_DATE}'), -462) THEN 67
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -475) AND days_add(to_date('${SNAPSHOT_DATE}'), -469) THEN 68
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -482) AND days_add(to_date('${SNAPSHOT_DATE}'), -476) THEN 69
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -489) AND days_add(to_date('${SNAPSHOT_DATE}'), -483) THEN 70
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -496) AND days_add(to_date('${SNAPSHOT_DATE}'), -490) THEN 71
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -503) AND days_add(to_date('${SNAPSHOT_DATE}'), -497) THEN 72
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -510) AND days_add(to_date('${SNAPSHOT_DATE}'), -504) THEN 73
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -517) AND days_add(to_date('${SNAPSHOT_DATE}'), -511) THEN 74
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -524) AND days_add(to_date('${SNAPSHOT_DATE}'), -518) THEN 75
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -531) AND days_add(to_date('${SNAPSHOT_DATE}'), -525) THEN 76
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -538) AND days_add(to_date('${SNAPSHOT_DATE}'), -532) THEN 77
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -545) AND days_add(to_date('${SNAPSHOT_DATE}'), -539) THEN 78
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -552) AND days_add(to_date('${SNAPSHOT_DATE}'), -546) THEN 79
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -559) AND days_add(to_date('${SNAPSHOT_DATE}'), -553) THEN 80
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -566) AND days_add(to_date('${SNAPSHOT_DATE}'), -560) THEN 81
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -573) AND days_add(to_date('${SNAPSHOT_DATE}'), -567) THEN 82
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -580) AND days_add(to_date('${SNAPSHOT_DATE}'), -574) THEN 83
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -587) AND days_add(to_date('${SNAPSHOT_DATE}'), -581) THEN 84
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -594) AND days_add(to_date('${SNAPSHOT_DATE}'), -588) THEN 85
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -601) AND days_add(to_date('${SNAPSHOT_DATE}'), -595) THEN 86
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -608) AND days_add(to_date('${SNAPSHOT_DATE}'), -602) THEN 87
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -615) AND days_add(to_date('${SNAPSHOT_DATE}'), -609) THEN 88
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -622) AND days_add(to_date('${SNAPSHOT_DATE}'), -616) THEN 89
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -629) AND days_add(to_date('${SNAPSHOT_DATE}'), -623) THEN 90
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -636) AND days_add(to_date('${SNAPSHOT_DATE}'), -630) THEN 91
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -643) AND days_add(to_date('${SNAPSHOT_DATE}'), -637) THEN 92
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -650) AND days_add(to_date('${SNAPSHOT_DATE}'), -644) THEN 93
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -657) AND days_add(to_date('${SNAPSHOT_DATE}'), -651) THEN 94
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -664) AND days_add(to_date('${SNAPSHOT_DATE}'), -658) THEN 95
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -671) AND days_add(to_date('${SNAPSHOT_DATE}'), -665) THEN 96
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -678) AND days_add(to_date('${SNAPSHOT_DATE}'), -672) THEN 97
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -685) AND days_add(to_date('${SNAPSHOT_DATE}'), -679) THEN 98
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -692) AND days_add(to_date('${SNAPSHOT_DATE}'), -686) THEN 99
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -699) AND days_add(to_date('${SNAPSHOT_DATE}'), -693) THEN 100
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -706) AND days_add(to_date('${SNAPSHOT_DATE}'), -700) THEN 101
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -713) AND days_add(to_date('${SNAPSHOT_DATE}'), -707) THEN 102
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -720) AND days_add(to_date('${SNAPSHOT_DATE}'), -714) THEN 103
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -727) AND days_add(to_date('${SNAPSHOT_DATE}'), -721) THEN 104
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -734) AND days_add(to_date('${SNAPSHOT_DATE}'), -728) THEN 105
        WHEN to_date(hierarchy_date) BETWEEN days_add(to_date('${SNAPSHOT_DATE}'), -741) AND days_add(to_date('${SNAPSHOT_DATE}'), -735) THEN 106

END AS rolling_week
FROM ${TBL_SRC_PERIOD}
where level_name='Day'
AND to_date(hierarchy_date) <= to_date('${SNAPSHOT_DATE}')
AND to_date(hierarchy_date) > days_add(to_date('${SNAPSHOT_DATE}'), -742)
;


[SQL_WEEKLY_1_CUT_CLEAR_DATA]

CREATE TABLE ${DB_NAME}.${TBL_1A_DATA_WEEKLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_1A_DATA_WEEKLY}'
AS
SELECT STRAIGHT_JOIN
t2.mmh_id
,T3.rolling_week
,SUM(t1.txn_cnt) AS txn_cnt
,SUM(t1.txn_amt) AS txn_amt

FROM ${TBL_SRC_CUTC} t1
INNER JOIN ${DB_NAME}.${TBL_0_LOOKUP_DATE_WEEKLY} T3 ON to_date(T3.de12_txn_date) = to_date(t1.de12_txn_date)
INNER JOIN ${DB_NAME}.${TBL_0B_MMHID_MONTHLY} t2 ON t2.old_loc_id = t1.location_id
GROUP BY t2.mmh_id,T3.rolling_week
;

[SQL_WEEKLY_2_DISTINCT_MERCHANTS]

CREATE TABLE ${DB_NAME}.${TBL_2_MERCHANTS_WEEKLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_2_MERCHANTS_WEEKLY}'
AS
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1A_DATA_WEEKLY}
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1A_DATA_MONTHLY}
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1B_AUTH_MONTHLY}
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1C_CHARGEBACK_MONTHLY}
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1D_ACCTMMHID_MONTHLY}
UNION
SELECT
distinct mmh_id
FROM ${DB_NAME}.${TBL_1E_ACCT_AUTH_DATA_MONTHLY}
;

[SQL_WEEKLY_3_ROLLING_WEEK_TABLE]

CREATE TABLE ${DB_NAME}.${TBL_3_ROLLING_WEEK}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_3_ROLLING_WEEK}'
AS
WITH nbrs1 AS
(
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
    SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1
)
,nbrs2 AS
(
    SELECT 1 AS n FROM nbrs1 CROSS JOIN nbrs1 AS b
)
,nbrs AS
(
    SELECT ROW_NUMBER() OVER (ORDER BY n)  AS rolling_week
    FROM nbrs2
)
SELECT rolling_week
FROM nbrs
WHERE rolling_week<=106;
;

[SQL_WEEKLY_4_MMHIDS_TO_ROLLINGWEEKS]

CREATE TABLE ${DB_NAME}.${TBL_4_MMHID_TO_ROLLING_WEEK}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_4_MMHID_TO_ROLLING_WEEK}'
AS
SELECT
t1.mmh_id
,t2.rolling_week
FROM ${DB_NAME}.${TBL_2_MERCHANTS_WEEKLY} t1
cross join ${DB_NAME}.${TBL_3_ROLLING_WEEK} t2
;

[SQL_WEEKLY_5_ROW_EXPLODE_CUT_CLEAR_DATA]

CREATE TABLE ${DB_NAME}.${TBL_5_EXPLODE_WEEKLY}
STORED AS parquet
LOCATION '${TBL_LOCATION}/${TBL_5_EXPLODE_WEEKLY}'
AS
SELECT STRAIGHT_JOIN
 t1.mmh_id
,t1.rolling_week

,to_date('${SNAPSHOT_DATE}')  AS txn_snapshot_date

,COALESCE(t2.txn_amt,0) AS txn_amt
,COALESCE(t2.txn_cnt,0) AS txn_cnt

FROM ${DB_NAME}.${TBL_4_MMHID_TO_ROLLING_WEEK} t1
LEFT OUTER JOIN [SHUFFLE] ${DB_NAME}.${TBL_1A_DATA_WEEKLY} t2 ON t2.mmh_id = t1.mmh_id AND t2.rolling_week = t1.rolling_week
;

[SQL_LABEL_MERCHANT_FEATURE_SCHEMA]

CREATE TABLE IF NOT EXISTS ${DB_NAME}.${TBL_I_FEATURE_STORE_LABEL} (
mmh_id bigint,
merchant_country STRING,

future_3m_txn_cnt INTEGER,
future_3m_txn_amt DOUBLE,
future_3m_attrition INTEGER

)
PARTITIONED BY (txn_snapshot_date STRING, region STRING)
STORED AS PARQUET
LOCATION '${TBL_LOCATION}/${TBL_I_FEATURE_STORE_LABEL}'
;

[SQL_HIST_MERCHANT_FEATURE_SCHEMA]
CREATE TABLE IF NOT EXISTS ${DB_NAME}.${TBL_I_FEATURE_STORE} (
mmh_id bigint,
merchant_country STRING,

txn_0m_1m_amt DOUBLE,
txn_0m_3m_amt DOUBLE,
txn_0m_6m_amt DOUBLE,
txn_0m_12m_amt DOUBLE,
txn_12m_24m_amt DOUBLE,
txn_0m_1m_cnt INTEGER,
txn_0m_3m_cnt INTEGER,
txn_0m_6m_cnt INTEGER,
txn_0m_12m_cnt INTEGER,
txn_12m_24m_cnt INTEGER,
txn_0m_12m_cnt_max DOUBLE,
txn_12m_24m_cnt_max DOUBLE,
txn_0m_12m_cnt_min DOUBLE,
txn_12m_24m_cnt_min DOUBLE,
txn_0m_12m_cnt_range DOUBLE,
txn_12m_24m_cnt_range DOUBLE,
txn_0m_12m_cnt_mean DOUBLE,
txn_12m_24m_cnt_mean DOUBLE,
txn_0m_12m_cnt_skew DOUBLE,
txn_12m_24m_cnt_skew DOUBLE,
txn_0m_12m_cnt_kurtosis DOUBLE,
txn_12m_24m_cnt_kurtosis DOUBLE,
txn_0m_12m_cnt_coeff_var DOUBLE,
txn_12m_24m_cnt_coeff_var DOUBLE,
txn_0m_12m_cnt_std DOUBLE,
txn_12m_24m_cnt_std DOUBLE,
txn_0m_12m_cnt_median DOUBLE,
txn_12m_24m_cnt_median DOUBLE,
txn_0m_12m_cnt_iqr DOUBLE,
txn_12m_24m_cnt_iqr DOUBLE,
txn_0m_12m_cnt_lq DOUBLE,
txn_12m_24m_cnt_lq DOUBLE,
txn_0m_12m_cnt_uq DOUBLE,
txn_12m_24m_cnt_uq DOUBLE,
txn_0m_12m_amt_max DOUBLE,
txn_12m_24m_amt_max DOUBLE,
txn_0m_12m_amt_min DOUBLE,
txn_12m_24m_amt_min DOUBLE,
txn_0m_12m_amt_range DOUBLE,
txn_12m_24m_amt_range DOUBLE,
txn_0m_12m_amt_mean DOUBLE,
txn_12m_24m_amt_mean DOUBLE,
txn_0m_12m_amt_skew DOUBLE,
txn_12m_24m_amt_skew DOUBLE,
txn_0m_12m_amt_kurtosis DOUBLE,
txn_12m_24m_amt_kurtosis DOUBLE,
txn_0m_12m_amt_coeff_var DOUBLE,
txn_12m_24m_amt_coeff_var DOUBLE,
txn_0m_12m_amt_std DOUBLE,
txn_12m_24m_amt_std DOUBLE,
txn_0m_12m_amt_median DOUBLE,
txn_12m_24m_amt_median DOUBLE,
txn_0m_12m_amt_iqr DOUBLE,
txn_12m_24m_amt_iqr DOUBLE,
txn_0m_12m_amt_lq DOUBLE,
txn_12m_24m_amt_lq DOUBLE,
txn_0m_12m_amt_uq DOUBLE,
txn_12m_24m_amt_uq DOUBLE,
paypass_0m_1m_cnt INTEGER,
paypass_0m_3m_cnt INTEGER,
paypass_0m_6m_cnt INTEGER,
paypass_0m_12m_cnt INTEGER,
paypass_12m_24m_cnt INTEGER,
paypass_0m_1m_amt DOUBLE,
paypass_0m_3m_amt DOUBLE,
paypass_0m_6m_amt DOUBLE,
paypass_0m_12m_amt DOUBLE,
paypass_12m_24m_amt DOUBLE,
chnp_0m_1m_cnt INTEGER,
chnp_0m_3m_cnt INTEGER,
chnp_0m_6m_cnt INTEGER,
chnp_0m_12m_cnt INTEGER,
chnp_12m_24m_cnt INTEGER,
chnp_0m_1m_amt DOUBLE,
chnp_0m_3m_amt DOUBLE,
chnp_0m_6m_amt DOUBLE,
chnp_0m_12m_amt DOUBLE,
chnp_12m_24m_amt DOUBLE,
chp_0m_1m_cnt INTEGER,
chp_0m_3m_cnt INTEGER,
chp_0m_6m_cnt INTEGER,
chp_0m_12m_cnt INTEGER,
chp_12m_24m_cnt INTEGER,
chp_0m_1m_amt DOUBLE,
chp_0m_3m_amt DOUBLE,
chp_0m_6m_amt DOUBLE,
chp_0m_12m_amt DOUBLE,
chp_12m_24m_amt DOUBLE,
cp_0m_1m_cnt INTEGER,
cp_0m_3m_cnt INTEGER,
cp_0m_6m_cnt INTEGER,
cp_0m_12m_cnt INTEGER,
cp_12m_24m_cnt INTEGER,
cp_0m_1m_amt DOUBLE,
cp_0m_3m_amt DOUBLE,
cp_0m_6m_amt DOUBLE,
cp_0m_12m_amt DOUBLE,
cp_12m_24m_amt DOUBLE,
recurring_0m_1m_cnt INTEGER,
recurring_0m_3m_cnt INTEGER,
recurring_0m_6m_cnt INTEGER,
recurring_0m_12m_cnt INTEGER,
recurring_12m_24m_cnt INTEGER,
recurring_0m_1m_amt DOUBLE,
recurring_0m_3m_amt DOUBLE,
recurring_0m_6m_amt DOUBLE,
recurring_0m_12m_amt DOUBLE,
recurring_12m_24m_amt DOUBLE,
online_0m_1m_cnt INTEGER,
online_0m_3m_cnt INTEGER,
online_0m_6m_cnt INTEGER,
online_0m_12m_cnt INTEGER,
online_12m_24m_cnt INTEGER,
online_0m_1m_amt DOUBLE,
online_0m_3m_amt DOUBLE,
online_0m_6m_amt DOUBLE,
online_0m_12m_amt DOUBLE,
online_12m_24m_amt DOUBLE,
tokenized_0m_1m_cnt INTEGER,
tokenized_0m_3m_cnt INTEGER,
tokenized_0m_6m_cnt INTEGER,
tokenized_0m_12m_cnt INTEGER,
tokenized_12m_24m_cnt INTEGER,
tokenized_0m_1m_amt DOUBLE,
tokenized_0m_3m_amt DOUBLE,
tokenized_0m_6m_amt DOUBLE,
tokenized_0m_12m_amt DOUBLE,
tokenized_12m_24m_amt DOUBLE,
cash_0m_1m_cnt INTEGER,
cash_0m_3m_cnt INTEGER,
cash_0m_6m_cnt INTEGER,
cash_0m_12m_cnt INTEGER,
cash_12m_24m_cnt INTEGER,
cash_0m_1m_amt DOUBLE,
cash_0m_3m_amt DOUBLE,
cash_0m_6m_amt DOUBLE,
cash_0m_12m_amt DOUBLE,
cash_12m_24m_amt DOUBLE,
reversed_0m_1m_cnt INTEGER,
reversed_0m_3m_cnt INTEGER,
reversed_0m_6m_cnt INTEGER,
reversed_0m_12m_cnt INTEGER,
reversed_12m_24m_cnt INTEGER,
reversed_0m_1m_amt DOUBLE,
reversed_0m_3m_amt DOUBLE,
reversed_0m_6m_amt DOUBLE,
reversed_0m_12m_amt DOUBLE,
reversed_12m_24m_amt DOUBLE,
small_business_0m_1m_cnt INTEGER,
small_business_0m_3m_cnt INTEGER,
small_business_0m_6m_cnt INTEGER,
small_business_0m_12m_cnt INTEGER,
small_business_12m_24m_cnt INTEGER,
small_business_0m_1m_amt DOUBLE,
small_business_0m_3m_amt DOUBLE,
small_business_0m_6m_amt DOUBLE,
small_business_0m_12m_amt DOUBLE,
small_business_12m_24m_amt DOUBLE,
dom_0m_1m_cnt INTEGER,
dom_0m_3m_cnt INTEGER,
dom_0m_6m_cnt INTEGER,
dom_0m_12m_cnt INTEGER,
dom_12m_24m_cnt INTEGER,
dom_0m_1m_amt DOUBLE,
dom_0m_3m_amt DOUBLE,
dom_0m_6m_amt DOUBLE,
dom_0m_12m_amt DOUBLE,
dom_12m_24m_amt DOUBLE,
xborder_0m_1m_cnt INTEGER,
xborder_0m_3m_cnt INTEGER,
xborder_0m_6m_cnt INTEGER,
xborder_0m_12m_cnt INTEGER,
xborder_12m_24m_cnt INTEGER,
xborder_0m_1m_amt DOUBLE,
xborder_0m_3m_amt DOUBLE,
xborder_0m_6m_amt DOUBLE,
xborder_0m_12m_amt DOUBLE,
xborder_12m_24m_amt DOUBLE,
approved_0m_1m_cnt INTEGER,
approved_0m_3m_cnt INTEGER,
approved_0m_6m_cnt INTEGER,
approved_0m_12m_cnt INTEGER,
approved_12m_24m_cnt INTEGER,
approved_0m_1m_amt DOUBLE,
approved_0m_3m_amt DOUBLE,
approved_0m_6m_amt DOUBLE,
approved_0m_12m_amt DOUBLE,
approved_12m_24m_amt DOUBLE,
declined_0m_1m_cnt INTEGER,
declined_0m_3m_cnt INTEGER,
declined_0m_6m_cnt INTEGER,
declined_0m_12m_cnt INTEGER,
declined_12m_24m_cnt INTEGER,
declined_0m_1m_amt DOUBLE,
declined_0m_3m_amt DOUBLE,
declined_0m_6m_amt DOUBLE,
declined_0m_12m_amt DOUBLE,
declined_12m_24m_amt DOUBLE,
chargeback_0m_1m_cnt INTEGER,
chargeback_0m_3m_cnt INTEGER,
chargeback_0m_6m_cnt INTEGER,
chargeback_0m_12m_cnt INTEGER,
chargeback_12m_24m_cnt INTEGER,
chargeback_0m_1m_amt DOUBLE,
chargeback_0m_3m_amt DOUBLE,
chargeback_0m_6m_amt DOUBLE,
chargeback_0m_12m_amt DOUBLE,
chargeback_12m_24m_amt DOUBLE,
first_chargeback_0m_1m_cnt INTEGER,
first_chargeback_0m_3m_cnt INTEGER,
first_chargeback_0m_6m_cnt INTEGER,
first_chargeback_0m_12m_cnt INTEGER,
first_chargeback_12m_24m_cnt INTEGER,
first_chargeback_0m_1m_amt DOUBLE,
first_chargeback_0m_3m_amt DOUBLE,
first_chargeback_0m_6m_amt DOUBLE,
first_chargeback_0m_12m_amt DOUBLE,
first_chargeback_12m_24m_amt DOUBLE,
representment_chargeback_0m_1m_cnt INTEGER,
representment_chargeback_0m_3m_cnt INTEGER,
representment_chargeback_0m_6m_cnt INTEGER,
representment_chargeback_0m_12m_cnt INTEGER,
representment_chargeback_12m_24m_cnt INTEGER,
representment_chargeback_0m_1m_amt DOUBLE,
representment_chargeback_0m_3m_amt DOUBLE,
representment_chargeback_0m_6m_amt DOUBLE,
representment_chargeback_0m_12m_amt DOUBLE,
representment_chargeback_12m_24m_amt DOUBLE,
arbitration_chargeback_0m_1m_cnt INTEGER,
arbitration_chargeback_0m_3m_cnt INTEGER,
arbitration_chargeback_0m_6m_cnt INTEGER,
arbitration_chargeback_0m_12m_cnt INTEGER,
arbitration_chargeback_12m_24m_cnt INTEGER,
arbitration_chargeback_0m_1m_amt DOUBLE,
arbitration_chargeback_0m_3m_amt DOUBLE,
arbitration_chargeback_0m_6m_amt DOUBLE,
arbitration_chargeback_0m_12m_amt DOUBLE,
arbitration_chargeback_12m_24m_amt DOUBLE,
fraud_chargeback_0m_1m_cnt INTEGER,
fraud_chargeback_0m_3m_cnt INTEGER,
fraud_chargeback_0m_6m_cnt INTEGER,
fraud_chargeback_0m_12m_cnt INTEGER,
fraud_chargeback_12m_24m_cnt INTEGER,
fraud_chargeback_0m_1m_amt DOUBLE,
fraud_chargeback_0m_3m_amt DOUBLE,
fraud_chargeback_0m_6m_amt DOUBLE,
fraud_chargeback_0m_12m_amt DOUBLE,
fraud_chargeback_12m_24m_amt DOUBLE,
cardholder_disputed_chargeback_0m_1m_cnt INTEGER,
cardholder_disputed_chargeback_0m_3m_cnt INTEGER,
cardholder_disputed_chargeback_0m_6m_cnt INTEGER,
cardholder_disputed_chargeback_0m_12m_cnt INTEGER,
cardholder_disputed_chargeback_12m_24m_cnt INTEGER,
cardholder_disputed_chargeback_0m_1m_amt DOUBLE,
cardholder_disputed_chargeback_0m_3m_amt DOUBLE,
cardholder_disputed_chargeback_0m_6m_amt DOUBLE,
cardholder_disputed_chargeback_0m_12m_amt DOUBLE,
cardholder_disputed_chargeback_12m_24m_amt DOUBLE,

tot_0m_1m_num_cards INTEGER,
tot_0m_3m_num_cards INTEGER,
tot_0m_6m_num_cards INTEGER,
tot_0m_12m_num_cards INTEGER,
tot_12m_24m_num_cards INTEGER,

cards_repeated_0m_1m_cnt INTEGER,
cards_repeated_0m_3m_cnt INTEGER,
cards_repeated_0m_6m_cnt INTEGER,
cards_repeated_0m_12m_cnt INTEGER,
cards_repeated_12m_24m_cnt INTEGER,

reversed_0m_1m_num_cards INTEGER,
reversed_0m_3m_num_cards INTEGER,
reversed_0m_6m_num_cards INTEGER,
reversed_0m_12m_num_cards INTEGER,
reversed_12m_24m_num_cards INTEGER,

online_0m_1m_num_cards INTEGER,
online_0m_3m_num_cards INTEGER,
online_0m_6m_num_cards INTEGER,
online_0m_12m_num_cards INTEGER,
online_12m_24m_num_cards INTEGER,

declined_0m_1m_num_cards INTEGER,
declined_0m_3m_num_cards INTEGER,
declined_0m_6m_num_cards INTEGER,
declined_0m_12m_num_cards INTEGER,
declined_12m_24m_num_cards INTEGER,

approved_0m_1m_num_cards INTEGER,
approved_0m_3m_num_cards INTEGER,
approved_0m_6m_num_cards INTEGER,
approved_0m_12m_num_cards INTEGER,
approved_12m_24m_num_cards INTEGER,

recurring_0m_1m_num_cards INTEGER,
recurring_0m_3m_num_cards INTEGER,
recurring_0m_6m_num_cards INTEGER,
recurring_0m_12m_num_cards INTEGER,
recurring_12m_24m_num_cards INTEGER,

txn_0w_1w_cnt INTEGER,
txn_1w_2w_cnt INTEGER,
txn_2w_3w_cnt INTEGER,
txn_3w_4w_cnt INTEGER,
txn_4w_5w_cnt INTEGER,
txn_5w_6w_cnt INTEGER,
txn_6w_7w_cnt INTEGER,
txn_7w_8w_cnt INTEGER,
txn_8w_9w_cnt INTEGER,
txn_9w_10w_cnt INTEGER,
txn_10w_11w_cnt INTEGER,
txn_11w_12w_cnt INTEGER,
txn_12w_13w_cnt INTEGER,
txn_13w_14w_cnt INTEGER,
txn_14w_15w_cnt INTEGER,
txn_15w_16w_cnt INTEGER,
txn_16w_17w_cnt INTEGER,
txn_17w_18w_cnt INTEGER,
txn_18w_19w_cnt INTEGER,
txn_19w_20w_cnt INTEGER,
txn_20w_21w_cnt INTEGER,
txn_21w_22w_cnt INTEGER,
txn_22w_23w_cnt INTEGER,
txn_23w_24w_cnt INTEGER,
txn_24w_25w_cnt INTEGER,
txn_25w_26w_cnt INTEGER,
txn_26w_27w_cnt INTEGER,
txn_27w_28w_cnt INTEGER,
txn_28w_29w_cnt INTEGER,
txn_29w_30w_cnt INTEGER,
txn_30w_31w_cnt INTEGER,
txn_31w_32w_cnt INTEGER,
txn_32w_33w_cnt INTEGER,
txn_33w_34w_cnt INTEGER,
txn_34w_35w_cnt INTEGER,
txn_35w_36w_cnt INTEGER,
txn_36w_37w_cnt INTEGER,
txn_37w_38w_cnt INTEGER,
txn_38w_39w_cnt INTEGER,
txn_39w_40w_cnt INTEGER,
txn_40w_41w_cnt INTEGER,
txn_41w_42w_cnt INTEGER,
txn_42w_43w_cnt INTEGER,
txn_43w_44w_cnt INTEGER,
txn_44w_45w_cnt INTEGER,
txn_45w_46w_cnt INTEGER,
txn_46w_47w_cnt INTEGER,
txn_47w_48w_cnt INTEGER,
txn_48w_49w_cnt INTEGER,
txn_49w_50w_cnt INTEGER,
txn_50w_51w_cnt INTEGER,
txn_51w_52w_cnt INTEGER,
txn_52w_53w_cnt INTEGER,
txn_53w_54w_cnt INTEGER,
txn_54w_55w_cnt INTEGER,
txn_55w_56w_cnt INTEGER,
txn_56w_57w_cnt INTEGER,
txn_57w_58w_cnt INTEGER,
txn_58w_59w_cnt INTEGER,
txn_59w_60w_cnt INTEGER,
txn_60w_61w_cnt INTEGER,
txn_61w_62w_cnt INTEGER,
txn_62w_63w_cnt INTEGER,
txn_63w_64w_cnt INTEGER,
txn_64w_65w_cnt INTEGER,
txn_65w_66w_cnt INTEGER,
txn_66w_67w_cnt INTEGER,
txn_67w_68w_cnt INTEGER,
txn_68w_69w_cnt INTEGER,
txn_69w_70w_cnt INTEGER,
txn_70w_71w_cnt INTEGER,
txn_71w_72w_cnt INTEGER,
txn_72w_73w_cnt INTEGER,
txn_73w_74w_cnt INTEGER,
txn_74w_75w_cnt INTEGER,
txn_75w_76w_cnt INTEGER,
txn_76w_77w_cnt INTEGER,
txn_77w_78w_cnt INTEGER,
txn_78w_79w_cnt INTEGER,
txn_79w_80w_cnt INTEGER,
txn_80w_81w_cnt INTEGER,
txn_81w_82w_cnt INTEGER,
txn_82w_83w_cnt INTEGER,
txn_83w_84w_cnt INTEGER,
txn_84w_85w_cnt INTEGER,
txn_85w_86w_cnt INTEGER,
txn_86w_87w_cnt INTEGER,
txn_87w_88w_cnt INTEGER,
txn_88w_89w_cnt INTEGER,
txn_89w_90w_cnt INTEGER,
txn_90w_91w_cnt INTEGER,
txn_91w_92w_cnt INTEGER,
txn_92w_93w_cnt INTEGER,
txn_93w_94w_cnt INTEGER,
txn_94w_95w_cnt INTEGER,
txn_95w_96w_cnt INTEGER,
txn_96w_97w_cnt INTEGER,
txn_97w_98w_cnt INTEGER,
txn_98w_99w_cnt INTEGER,
txn_99w_100w_cnt INTEGER,
txn_100w_101w_cnt INTEGER,
txn_101w_102w_cnt INTEGER,
txn_102w_103w_cnt INTEGER,
txn_103w_104w_cnt INTEGER,
txn_104w_105w_cnt INTEGER,
txn_105w_106w_cnt INTEGER,

txn_0w_1w_amt double,
txn_1w_2w_amt double,
txn_2w_3w_amt double,
txn_3w_4w_amt double,
txn_4w_5w_amt double,
txn_5w_6w_amt double,
txn_6w_7w_amt double,
txn_7w_8w_amt double,
txn_8w_9w_amt double,
txn_9w_10w_amt double,
txn_10w_11w_amt double,
txn_11w_12w_amt double,
txn_12w_13w_amt double,
txn_13w_14w_amt double,
txn_14w_15w_amt double,
txn_15w_16w_amt double,
txn_16w_17w_amt double,
txn_17w_18w_amt double,
txn_18w_19w_amt double,
txn_19w_20w_amt double,
txn_20w_21w_amt double,
txn_21w_22w_amt double,
txn_22w_23w_amt double,
txn_23w_24w_amt double,
txn_24w_25w_amt double,
txn_25w_26w_amt double,
txn_26w_27w_amt double,
txn_27w_28w_amt double,
txn_28w_29w_amt double,
txn_29w_30w_amt double,
txn_30w_31w_amt double,
txn_31w_32w_amt double,
txn_32w_33w_amt double,
txn_33w_34w_amt double,
txn_34w_35w_amt double,
txn_35w_36w_amt double,
txn_36w_37w_amt double,
txn_37w_38w_amt double,
txn_38w_39w_amt double,
txn_39w_40w_amt double,
txn_40w_41w_amt double,
txn_41w_42w_amt double,
txn_42w_43w_amt double,
txn_43w_44w_amt double,
txn_44w_45w_amt double,
txn_45w_46w_amt double,
txn_46w_47w_amt double,
txn_47w_48w_amt double,
txn_48w_49w_amt double,
txn_49w_50w_amt double,
txn_50w_51w_amt double,
txn_51w_52w_amt double,
txn_52w_53w_amt double,
txn_53w_54w_amt double,
txn_54w_55w_amt double,
txn_55w_56w_amt double,
txn_56w_57w_amt double,
txn_57w_58w_amt double,
txn_58w_59w_amt double,
txn_59w_60w_amt double,
txn_60w_61w_amt double,
txn_61w_62w_amt double,
txn_62w_63w_amt double,
txn_63w_64w_amt double,
txn_64w_65w_amt double,
txn_65w_66w_amt double,
txn_66w_67w_amt double,
txn_67w_68w_amt double,
txn_68w_69w_amt double,
txn_69w_70w_amt double,
txn_70w_71w_amt double,
txn_71w_72w_amt double,
txn_72w_73w_amt double,
txn_73w_74w_amt double,
txn_74w_75w_amt double,
txn_75w_76w_amt double,
txn_76w_77w_amt double,
txn_77w_78w_amt double,
txn_78w_79w_amt double,
txn_79w_80w_amt double,
txn_80w_81w_amt double,
txn_81w_82w_amt double,
txn_82w_83w_amt double,
txn_83w_84w_amt double,
txn_84w_85w_amt double,
txn_85w_86w_amt double,
txn_86w_87w_amt double,
txn_87w_88w_amt double,
txn_88w_89w_amt double,
txn_89w_90w_amt double,
txn_90w_91w_amt double,
txn_91w_92w_amt double,
txn_92w_93w_amt double,
txn_93w_94w_amt double,
txn_94w_95w_amt double,
txn_95w_96w_amt double,
txn_96w_97w_amt double,
txn_97w_98w_amt double,
txn_98w_99w_amt double,
txn_99w_100w_amt double,
txn_100w_101w_amt double,
txn_101w_102w_amt double,
txn_102w_103w_amt double,
txn_103w_104w_amt double,
txn_104w_105w_amt double,
txn_105w_106w_amt double,

competitors_postalcode_ind_0m_1m_cnt INTEGER,
competitors_postalcode_ind_0m_3m_cnt INTEGER,
competitors_postalcode_ind_0m_6m_cnt INTEGER,
competitors_postalcode_ind_0m_12m_cnt INTEGER,
competitors_postalcode_ind_12m_24m_cnt INTEGER,

competitor_postalcode_ind_txn_0m_1m_amt DOUBLE,
competitor_postalcode_ind_txn_0m_3m_amt DOUBLE,
competitor_postalcode_ind_txn_0m_6m_amt DOUBLE,
competitor_postalcode_ind_txn_0m_12m_amt DOUBLE,
competitor_postalcode_ind_txn_12m_24m_amt DOUBLE,

competitor_postalcode_ind_txn_0m_1m_cnt INTEGER,
competitor_postalcode_ind_txn_0m_3m_cnt INTEGER,
competitor_postalcode_ind_txn_0m_6m_cnt INTEGER,
competitor_postalcode_ind_txn_0m_12m_cnt INTEGER,
competitor_postalcode_ind_txn_12m_24m_cnt INTEGER,

competitors_postalcode_superind_0m_1m_cnt INTEGER,
competitors_postalcode_superind_0m_3m_cnt INTEGER,
competitors_postalcode_superind_0m_6m_cnt INTEGER,
competitors_postalcode_superind_0m_12m_cnt INTEGER,
competitors_postalcode_superind_12m_24m_cnt INTEGER,

competitor_postalcode_superind_txn_0m_1m_amt DOUBLE,
competitor_postalcode_superind_txn_0m_3m_amt DOUBLE,
competitor_postalcode_superind_txn_0m_6m_amt DOUBLE,
competitor_postalcode_superind_txn_0m_12m_amt DOUBLE,
competitor_postalcode_superind_txn_12m_24m_amt DOUBLE,

competitor_postalcode_superind_txn_0m_1m_cnt INTEGER,
competitor_postalcode_superind_txn_0m_3m_cnt INTEGER,
competitor_postalcode_superind_txn_0m_6m_cnt INTEGER,
competitor_postalcode_superind_txn_0m_12m_cnt INTEGER,
competitor_postalcode_superind_txn_12m_24m_cnt INTEGER
)
PARTITIONED BY (txn_snapshot_date STRING, region STRING )
STORED AS PARQUET
LOCATION '${TBL_LOCATION}/${TBL_I_FEATURE_STORE}'
;

[SQL_HIST_MERCHANT_FEATURE_SERVING_SCHEMA]
CREATE TABLE IF NOT EXISTS ${DB_NAME}.${TBL_I_FEATURE_STORE_SERVING} (
mmh_id bigint,
merchant_country STRING,

txn_0m_1m_amt DOUBLE,
txn_0m_3m_amt DOUBLE,
txn_0m_6m_amt DOUBLE,
txn_0m_12m_amt DOUBLE,
txn_12m_24m_amt DOUBLE,
txn_0m_1m_cnt INTEGER,
txn_0m_3m_cnt INTEGER,
txn_0m_6m_cnt INTEGER,
txn_0m_12m_cnt INTEGER,
txn_12m_24m_cnt INTEGER,
txn_0m_12m_cnt_max DOUBLE,
txn_12m_24m_cnt_max DOUBLE,
txn_0m_12m_cnt_min DOUBLE,
txn_12m_24m_cnt_min DOUBLE,
txn_0m_12m_cnt_range DOUBLE,
txn_12m_24m_cnt_range DOUBLE,
txn_0m_12m_cnt_mean DOUBLE,
txn_12m_24m_cnt_mean DOUBLE,
txn_0m_12m_cnt_skew DOUBLE,
txn_12m_24m_cnt_skew DOUBLE,
txn_0m_12m_cnt_kurtosis DOUBLE,
txn_12m_24m_cnt_kurtosis DOUBLE,
txn_0m_12m_cnt_coeff_var DOUBLE,
txn_12m_24m_cnt_coeff_var DOUBLE,
txn_0m_12m_cnt_std DOUBLE,
txn_12m_24m_cnt_std DOUBLE,
txn_0m_12m_cnt_median DOUBLE,
txn_12m_24m_cnt_median DOUBLE,
txn_0m_12m_cnt_iqr DOUBLE,
txn_12m_24m_cnt_iqr DOUBLE,
txn_0m_12m_cnt_lq DOUBLE,
txn_12m_24m_cnt_lq DOUBLE,
txn_0m_12m_cnt_uq DOUBLE,
txn_12m_24m_cnt_uq DOUBLE,
txn_0m_12m_amt_max DOUBLE,
txn_12m_24m_amt_max DOUBLE,
txn_0m_12m_amt_min DOUBLE,
txn_12m_24m_amt_min DOUBLE,
txn_0m_12m_amt_range DOUBLE,
txn_12m_24m_amt_range DOUBLE,
txn_0m_12m_amt_mean DOUBLE,
txn_12m_24m_amt_mean DOUBLE,
txn_0m_12m_amt_skew DOUBLE,
txn_12m_24m_amt_skew DOUBLE,
txn_0m_12m_amt_kurtosis DOUBLE,
txn_12m_24m_amt_kurtosis DOUBLE,
txn_0m_12m_amt_coeff_var DOUBLE,
txn_12m_24m_amt_coeff_var DOUBLE,
txn_0m_12m_amt_std DOUBLE,
txn_12m_24m_amt_std DOUBLE,
txn_0m_12m_amt_median DOUBLE,
txn_12m_24m_amt_median DOUBLE,
txn_0m_12m_amt_iqr DOUBLE,
txn_12m_24m_amt_iqr DOUBLE,
txn_0m_12m_amt_lq DOUBLE,
txn_12m_24m_amt_lq DOUBLE,
txn_0m_12m_amt_uq DOUBLE,
txn_12m_24m_amt_uq DOUBLE,
paypass_0m_1m_cnt INTEGER,
paypass_0m_3m_cnt INTEGER,
paypass_0m_6m_cnt INTEGER,
paypass_0m_12m_cnt INTEGER,
paypass_12m_24m_cnt INTEGER,
paypass_0m_1m_amt DOUBLE,
paypass_0m_3m_amt DOUBLE,
paypass_0m_6m_amt DOUBLE,
paypass_0m_12m_amt DOUBLE,
paypass_12m_24m_amt DOUBLE,
chnp_0m_1m_cnt INTEGER,
chnp_0m_3m_cnt INTEGER,
chnp_0m_6m_cnt INTEGER,
chnp_0m_12m_cnt INTEGER,
chnp_12m_24m_cnt INTEGER,
chnp_0m_1m_amt DOUBLE,
chnp_0m_3m_amt DOUBLE,
chnp_0m_6m_amt DOUBLE,
chnp_0m_12m_amt DOUBLE,
chnp_12m_24m_amt DOUBLE,
chp_0m_1m_cnt INTEGER,
chp_0m_3m_cnt INTEGER,
chp_0m_6m_cnt INTEGER,
chp_0m_12m_cnt INTEGER,
chp_12m_24m_cnt INTEGER,
chp_0m_1m_amt DOUBLE,
chp_0m_3m_amt DOUBLE,
chp_0m_6m_amt DOUBLE,
chp_0m_12m_amt DOUBLE,
chp_12m_24m_amt DOUBLE,
cp_0m_1m_cnt INTEGER,
cp_0m_3m_cnt INTEGER,
cp_0m_6m_cnt INTEGER,
cp_0m_12m_cnt INTEGER,
cp_12m_24m_cnt INTEGER,
cp_0m_1m_amt DOUBLE,
cp_0m_3m_amt DOUBLE,
cp_0m_6m_amt DOUBLE,
cp_0m_12m_amt DOUBLE,
cp_12m_24m_amt DOUBLE,
recurring_0m_1m_cnt INTEGER,
recurring_0m_3m_cnt INTEGER,
recurring_0m_6m_cnt INTEGER,
recurring_0m_12m_cnt INTEGER,
recurring_12m_24m_cnt INTEGER,
recurring_0m_1m_amt DOUBLE,
recurring_0m_3m_amt DOUBLE,
recurring_0m_6m_amt DOUBLE,
recurring_0m_12m_amt DOUBLE,
recurring_12m_24m_amt DOUBLE,
online_0m_1m_cnt INTEGER,
online_0m_3m_cnt INTEGER,
online_0m_6m_cnt INTEGER,
online_0m_12m_cnt INTEGER,
online_12m_24m_cnt INTEGER,
online_0m_1m_amt DOUBLE,
online_0m_3m_amt DOUBLE,
online_0m_6m_amt DOUBLE,
online_0m_12m_amt DOUBLE,
online_12m_24m_amt DOUBLE,
tokenized_0m_1m_cnt INTEGER,
tokenized_0m_3m_cnt INTEGER,
tokenized_0m_6m_cnt INTEGER,
tokenized_0m_12m_cnt INTEGER,
tokenized_12m_24m_cnt INTEGER,
tokenized_0m_1m_amt DOUBLE,
tokenized_0m_3m_amt DOUBLE,
tokenized_0m_6m_amt DOUBLE,
tokenized_0m_12m_amt DOUBLE,
tokenized_12m_24m_amt DOUBLE,
cash_0m_1m_cnt INTEGER,
cash_0m_3m_cnt INTEGER,
cash_0m_6m_cnt INTEGER,
cash_0m_12m_cnt INTEGER,
cash_12m_24m_cnt INTEGER,
cash_0m_1m_amt DOUBLE,
cash_0m_3m_amt DOUBLE,
cash_0m_6m_amt DOUBLE,
cash_0m_12m_amt DOUBLE,
cash_12m_24m_amt DOUBLE,
reversed_0m_1m_cnt INTEGER,
reversed_0m_3m_cnt INTEGER,
reversed_0m_6m_cnt INTEGER,
reversed_0m_12m_cnt INTEGER,
reversed_12m_24m_cnt INTEGER,
reversed_0m_1m_amt DOUBLE,
reversed_0m_3m_amt DOUBLE,
reversed_0m_6m_amt DOUBLE,
reversed_0m_12m_amt DOUBLE,
reversed_12m_24m_amt DOUBLE,
small_business_0m_1m_cnt INTEGER,
small_business_0m_3m_cnt INTEGER,
small_business_0m_6m_cnt INTEGER,
small_business_0m_12m_cnt INTEGER,
small_business_12m_24m_cnt INTEGER,
small_business_0m_1m_amt DOUBLE,
small_business_0m_3m_amt DOUBLE,
small_business_0m_6m_amt DOUBLE,
small_business_0m_12m_amt DOUBLE,
small_business_12m_24m_amt DOUBLE,
dom_0m_1m_cnt INTEGER,
dom_0m_3m_cnt INTEGER,
dom_0m_6m_cnt INTEGER,
dom_0m_12m_cnt INTEGER,
dom_12m_24m_cnt INTEGER,
dom_0m_1m_amt DOUBLE,
dom_0m_3m_amt DOUBLE,
dom_0m_6m_amt DOUBLE,
dom_0m_12m_amt DOUBLE,
dom_12m_24m_amt DOUBLE,
xborder_0m_1m_cnt INTEGER,
xborder_0m_3m_cnt INTEGER,
xborder_0m_6m_cnt INTEGER,
xborder_0m_12m_cnt INTEGER,
xborder_12m_24m_cnt INTEGER,
xborder_0m_1m_amt DOUBLE,
xborder_0m_3m_amt DOUBLE,
xborder_0m_6m_amt DOUBLE,
xborder_0m_12m_amt DOUBLE,
xborder_12m_24m_amt DOUBLE,
approved_0m_1m_cnt INTEGER,
approved_0m_3m_cnt INTEGER,
approved_0m_6m_cnt INTEGER,
approved_0m_12m_cnt INTEGER,
approved_12m_24m_cnt INTEGER,
approved_0m_1m_amt DOUBLE,
approved_0m_3m_amt DOUBLE,
approved_0m_6m_amt DOUBLE,
approved_0m_12m_amt DOUBLE,
approved_12m_24m_amt DOUBLE,
declined_0m_1m_cnt INTEGER,
declined_0m_3m_cnt INTEGER,
declined_0m_6m_cnt INTEGER,
declined_0m_12m_cnt INTEGER,
declined_12m_24m_cnt INTEGER,
declined_0m_1m_amt DOUBLE,
declined_0m_3m_amt DOUBLE,
declined_0m_6m_amt DOUBLE,
declined_0m_12m_amt DOUBLE,
declined_12m_24m_amt DOUBLE,
chargeback_0m_1m_cnt INTEGER,
chargeback_0m_3m_cnt INTEGER,
chargeback_0m_6m_cnt INTEGER,
chargeback_0m_12m_cnt INTEGER,
chargeback_12m_24m_cnt INTEGER,
chargeback_0m_1m_amt DOUBLE,
chargeback_0m_3m_amt DOUBLE,
chargeback_0m_6m_amt DOUBLE,
chargeback_0m_12m_amt DOUBLE,
chargeback_12m_24m_amt DOUBLE,
first_chargeback_0m_1m_cnt INTEGER,
first_chargeback_0m_3m_cnt INTEGER,
first_chargeback_0m_6m_cnt INTEGER,
first_chargeback_0m_12m_cnt INTEGER,
first_chargeback_12m_24m_cnt INTEGER,
first_chargeback_0m_1m_amt DOUBLE,
first_chargeback_0m_3m_amt DOUBLE,
first_chargeback_0m_6m_amt DOUBLE,
first_chargeback_0m_12m_amt DOUBLE,
first_chargeback_12m_24m_amt DOUBLE,
representment_chargeback_0m_1m_cnt INTEGER,
representment_chargeback_0m_3m_cnt INTEGER,
representment_chargeback_0m_6m_cnt INTEGER,
representment_chargeback_0m_12m_cnt INTEGER,
representment_chargeback_12m_24m_cnt INTEGER,
representment_chargeback_0m_1m_amt DOUBLE,
representment_chargeback_0m_3m_amt DOUBLE,
representment_chargeback_0m_6m_amt DOUBLE,
representment_chargeback_0m_12m_amt DOUBLE,
representment_chargeback_12m_24m_amt DOUBLE,
arbitration_chargeback_0m_1m_cnt INTEGER,
arbitration_chargeback_0m_3m_cnt INTEGER,
arbitration_chargeback_0m_6m_cnt INTEGER,
arbitration_chargeback_0m_12m_cnt INTEGER,
arbitration_chargeback_12m_24m_cnt INTEGER,
arbitration_chargeback_0m_1m_amt DOUBLE,
arbitration_chargeback_0m_3m_amt DOUBLE,
arbitration_chargeback_0m_6m_amt DOUBLE,
arbitration_chargeback_0m_12m_amt DOUBLE,
arbitration_chargeback_12m_24m_amt DOUBLE,
fraud_chargeback_0m_1m_cnt INTEGER,
fraud_chargeback_0m_3m_cnt INTEGER,
fraud_chargeback_0m_6m_cnt INTEGER,
fraud_chargeback_0m_12m_cnt INTEGER,
fraud_chargeback_12m_24m_cnt INTEGER,
fraud_chargeback_0m_1m_amt DOUBLE,
fraud_chargeback_0m_3m_amt DOUBLE,
fraud_chargeback_0m_6m_amt DOUBLE,
fraud_chargeback_0m_12m_amt DOUBLE,
fraud_chargeback_12m_24m_amt DOUBLE,
cardholder_disputed_chargeback_0m_1m_cnt INTEGER,
cardholder_disputed_chargeback_0m_3m_cnt INTEGER,
cardholder_disputed_chargeback_0m_6m_cnt INTEGER,
cardholder_disputed_chargeback_0m_12m_cnt INTEGER,
cardholder_disputed_chargeback_12m_24m_cnt INTEGER,
cardholder_disputed_chargeback_0m_1m_amt DOUBLE,
cardholder_disputed_chargeback_0m_3m_amt DOUBLE,
cardholder_disputed_chargeback_0m_6m_amt DOUBLE,
cardholder_disputed_chargeback_0m_12m_amt DOUBLE,
cardholder_disputed_chargeback_12m_24m_amt DOUBLE,

tot_0m_1m_num_cards INTEGER,
tot_0m_3m_num_cards INTEGER,
tot_0m_6m_num_cards INTEGER,
tot_0m_12m_num_cards INTEGER,
tot_12m_24m_num_cards INTEGER,

cards_repeated_0m_1m_cnt INTEGER,
cards_repeated_0m_3m_cnt INTEGER,
cards_repeated_0m_6m_cnt INTEGER,
cards_repeated_0m_12m_cnt INTEGER,
cards_repeated_12m_24m_cnt INTEGER,

reversed_0m_1m_num_cards INTEGER,
reversed_0m_3m_num_cards INTEGER,
reversed_0m_6m_num_cards INTEGER,
reversed_0m_12m_num_cards INTEGER,
reversed_12m_24m_num_cards INTEGER,

online_0m_1m_num_cards INTEGER,
online_0m_3m_num_cards INTEGER,
online_0m_6m_num_cards INTEGER,
online_0m_12m_num_cards INTEGER,
online_12m_24m_num_cards INTEGER,

declined_0m_1m_num_cards INTEGER,
declined_0m_3m_num_cards INTEGER,
declined_0m_6m_num_cards INTEGER,
declined_0m_12m_num_cards INTEGER,
declined_12m_24m_num_cards INTEGER,

approved_0m_1m_num_cards INTEGER,
approved_0m_3m_num_cards INTEGER,
approved_0m_6m_num_cards INTEGER,
approved_0m_12m_num_cards INTEGER,
approved_12m_24m_num_cards INTEGER,

recurring_0m_1m_num_cards INTEGER,
recurring_0m_3m_num_cards INTEGER,
recurring_0m_6m_num_cards INTEGER,
recurring_0m_12m_num_cards INTEGER,
recurring_12m_24m_num_cards INTEGER,

txn_0w_1w_cnt INTEGER,
txn_1w_2w_cnt INTEGER,
txn_2w_3w_cnt INTEGER,
txn_3w_4w_cnt INTEGER,
txn_4w_5w_cnt INTEGER,
txn_5w_6w_cnt INTEGER,
txn_6w_7w_cnt INTEGER,
txn_7w_8w_cnt INTEGER,
txn_8w_9w_cnt INTEGER,
txn_9w_10w_cnt INTEGER,
txn_10w_11w_cnt INTEGER,
txn_11w_12w_cnt INTEGER,
txn_12w_13w_cnt INTEGER,
txn_13w_14w_cnt INTEGER,
txn_14w_15w_cnt INTEGER,
txn_15w_16w_cnt INTEGER,
txn_16w_17w_cnt INTEGER,
txn_17w_18w_cnt INTEGER,
txn_18w_19w_cnt INTEGER,
txn_19w_20w_cnt INTEGER,
txn_20w_21w_cnt INTEGER,
txn_21w_22w_cnt INTEGER,
txn_22w_23w_cnt INTEGER,
txn_23w_24w_cnt INTEGER,
txn_24w_25w_cnt INTEGER,
txn_25w_26w_cnt INTEGER,
txn_26w_27w_cnt INTEGER,
txn_27w_28w_cnt INTEGER,
txn_28w_29w_cnt INTEGER,
txn_29w_30w_cnt INTEGER,
txn_30w_31w_cnt INTEGER,
txn_31w_32w_cnt INTEGER,
txn_32w_33w_cnt INTEGER,
txn_33w_34w_cnt INTEGER,
txn_34w_35w_cnt INTEGER,
txn_35w_36w_cnt INTEGER,
txn_36w_37w_cnt INTEGER,
txn_37w_38w_cnt INTEGER,
txn_38w_39w_cnt INTEGER,
txn_39w_40w_cnt INTEGER,
txn_40w_41w_cnt INTEGER,
txn_41w_42w_cnt INTEGER,
txn_42w_43w_cnt INTEGER,
txn_43w_44w_cnt INTEGER,
txn_44w_45w_cnt INTEGER,
txn_45w_46w_cnt INTEGER,
txn_46w_47w_cnt INTEGER,
txn_47w_48w_cnt INTEGER,
txn_48w_49w_cnt INTEGER,
txn_49w_50w_cnt INTEGER,
txn_50w_51w_cnt INTEGER,
txn_51w_52w_cnt INTEGER,
txn_52w_53w_cnt INTEGER,
txn_53w_54w_cnt INTEGER,
txn_54w_55w_cnt INTEGER,
txn_55w_56w_cnt INTEGER,
txn_56w_57w_cnt INTEGER,
txn_57w_58w_cnt INTEGER,
txn_58w_59w_cnt INTEGER,
txn_59w_60w_cnt INTEGER,
txn_60w_61w_cnt INTEGER,
txn_61w_62w_cnt INTEGER,
txn_62w_63w_cnt INTEGER,
txn_63w_64w_cnt INTEGER,
txn_64w_65w_cnt INTEGER,
txn_65w_66w_cnt INTEGER,
txn_66w_67w_cnt INTEGER,
txn_67w_68w_cnt INTEGER,
txn_68w_69w_cnt INTEGER,
txn_69w_70w_cnt INTEGER,
txn_70w_71w_cnt INTEGER,
txn_71w_72w_cnt INTEGER,
txn_72w_73w_cnt INTEGER,
txn_73w_74w_cnt INTEGER,
txn_74w_75w_cnt INTEGER,
txn_75w_76w_cnt INTEGER,
txn_76w_77w_cnt INTEGER,
txn_77w_78w_cnt INTEGER,
txn_78w_79w_cnt INTEGER,
txn_79w_80w_cnt INTEGER,
txn_80w_81w_cnt INTEGER,
txn_81w_82w_cnt INTEGER,
txn_82w_83w_cnt INTEGER,
txn_83w_84w_cnt INTEGER,
txn_84w_85w_cnt INTEGER,
txn_85w_86w_cnt INTEGER,
txn_86w_87w_cnt INTEGER,
txn_87w_88w_cnt INTEGER,
txn_88w_89w_cnt INTEGER,
txn_89w_90w_cnt INTEGER,
txn_90w_91w_cnt INTEGER,
txn_91w_92w_cnt INTEGER,
txn_92w_93w_cnt INTEGER,
txn_93w_94w_cnt INTEGER,
txn_94w_95w_cnt INTEGER,
txn_95w_96w_cnt INTEGER,
txn_96w_97w_cnt INTEGER,
txn_97w_98w_cnt INTEGER,
txn_98w_99w_cnt INTEGER,
txn_99w_100w_cnt INTEGER,
txn_100w_101w_cnt INTEGER,
txn_101w_102w_cnt INTEGER,
txn_102w_103w_cnt INTEGER,
txn_103w_104w_cnt INTEGER,
txn_104w_105w_cnt INTEGER,
txn_105w_106w_cnt INTEGER,

txn_0w_1w_amt double,
txn_1w_2w_amt double,
txn_2w_3w_amt double,
txn_3w_4w_amt double,
txn_4w_5w_amt double,
txn_5w_6w_amt double,
txn_6w_7w_amt double,
txn_7w_8w_amt double,
txn_8w_9w_amt double,
txn_9w_10w_amt double,
txn_10w_11w_amt double,
txn_11w_12w_amt double,
txn_12w_13w_amt double,
txn_13w_14w_amt double,
txn_14w_15w_amt double,
txn_15w_16w_amt double,
txn_16w_17w_amt double,
txn_17w_18w_amt double,
txn_18w_19w_amt double,
txn_19w_20w_amt double,
txn_20w_21w_amt double,
txn_21w_22w_amt double,
txn_22w_23w_amt double,
txn_23w_24w_amt double,
txn_24w_25w_amt double,
txn_25w_26w_amt double,
txn_26w_27w_amt double,
txn_27w_28w_amt double,
txn_28w_29w_amt double,
txn_29w_30w_amt double,
txn_30w_31w_amt double,
txn_31w_32w_amt double,
txn_32w_33w_amt double,
txn_33w_34w_amt double,
txn_34w_35w_amt double,
txn_35w_36w_amt double,
txn_36w_37w_amt double,
txn_37w_38w_amt double,
txn_38w_39w_amt double,
txn_39w_40w_amt double,
txn_40w_41w_amt double,
txn_41w_42w_amt double,
txn_42w_43w_amt double,
txn_43w_44w_amt double,
txn_44w_45w_amt double,
txn_45w_46w_amt double,
txn_46w_47w_amt double,
txn_47w_48w_amt double,
txn_48w_49w_amt double,
txn_49w_50w_amt double,
txn_50w_51w_amt double,
txn_51w_52w_amt double,
txn_52w_53w_amt double,
txn_53w_54w_amt double,
txn_54w_55w_amt double,
txn_55w_56w_amt double,
txn_56w_57w_amt double,
txn_57w_58w_amt double,
txn_58w_59w_amt double,
txn_59w_60w_amt double,
txn_60w_61w_amt double,
txn_61w_62w_amt double,
txn_62w_63w_amt double,
txn_63w_64w_amt double,
txn_64w_65w_amt double,
txn_65w_66w_amt double,
txn_66w_67w_amt double,
txn_67w_68w_amt double,
txn_68w_69w_amt double,
txn_69w_70w_amt double,
txn_70w_71w_amt double,
txn_71w_72w_amt double,
txn_72w_73w_amt double,
txn_73w_74w_amt double,
txn_74w_75w_amt double,
txn_75w_76w_amt double,
txn_76w_77w_amt double,
txn_77w_78w_amt double,
txn_78w_79w_amt double,
txn_79w_80w_amt double,
txn_80w_81w_amt double,
txn_81w_82w_amt double,
txn_82w_83w_amt double,
txn_83w_84w_amt double,
txn_84w_85w_amt double,
txn_85w_86w_amt double,
txn_86w_87w_amt double,
txn_87w_88w_amt double,
txn_88w_89w_amt double,
txn_89w_90w_amt double,
txn_90w_91w_amt double,
txn_91w_92w_amt double,
txn_92w_93w_amt double,
txn_93w_94w_amt double,
txn_94w_95w_amt double,
txn_95w_96w_amt double,
txn_96w_97w_amt double,
txn_97w_98w_amt double,
txn_98w_99w_amt double,
txn_99w_100w_amt double,
txn_100w_101w_amt double,
txn_101w_102w_amt double,
txn_102w_103w_amt double,
txn_103w_104w_amt double,
txn_104w_105w_amt double,
txn_105w_106w_amt double,

competitors_postalcode_ind_0m_1m_cnt INTEGER,
competitors_postalcode_ind_0m_3m_cnt INTEGER,
competitors_postalcode_ind_0m_6m_cnt INTEGER,
competitors_postalcode_ind_0m_12m_cnt INTEGER,
competitors_postalcode_ind_12m_24m_cnt INTEGER,

competitor_postalcode_ind_txn_0m_1m_amt DOUBLE,
competitor_postalcode_ind_txn_0m_3m_amt DOUBLE,
competitor_postalcode_ind_txn_0m_6m_amt DOUBLE,
competitor_postalcode_ind_txn_0m_12m_amt DOUBLE,
competitor_postalcode_ind_txn_12m_24m_amt DOUBLE,

competitor_postalcode_ind_txn_0m_1m_cnt INTEGER,
competitor_postalcode_ind_txn_0m_3m_cnt INTEGER,
competitor_postalcode_ind_txn_0m_6m_cnt INTEGER,
competitor_postalcode_ind_txn_0m_12m_cnt INTEGER,
competitor_postalcode_ind_txn_12m_24m_cnt INTEGER,

competitors_postalcode_superind_0m_1m_cnt INTEGER,
competitors_postalcode_superind_0m_3m_cnt INTEGER,
competitors_postalcode_superind_0m_6m_cnt INTEGER,
competitors_postalcode_superind_0m_12m_cnt INTEGER,
competitors_postalcode_superind_12m_24m_cnt INTEGER,

competitor_postalcode_superind_txn_0m_1m_amt DOUBLE,
competitor_postalcode_superind_txn_0m_3m_amt DOUBLE,
competitor_postalcode_superind_txn_0m_6m_amt DOUBLE,
competitor_postalcode_superind_txn_0m_12m_amt DOUBLE,
competitor_postalcode_superind_txn_12m_24m_amt DOUBLE,

competitor_postalcode_superind_txn_0m_1m_cnt INTEGER,
competitor_postalcode_superind_txn_0m_3m_cnt INTEGER,
competitor_postalcode_superind_txn_0m_6m_cnt INTEGER,
competitor_postalcode_superind_txn_0m_12m_cnt INTEGER,
competitor_postalcode_superind_txn_12m_24m_cnt INTEGER
)
PARTITIONED BY (txn_snapshot_date STRING, region STRING)
STORED AS PARQUET
LOCATION '${TBL_LOCATION}/${TBL_I_FEATURE_STORE_SERVING}'
;

[SQL_SPARK_HIST_LABEL_MERCH_FEATURE]
spark-submit --master yarn --deploy-mode client \
                        --conf spark.ui.port=5050 \
                        --conf spark.authenticate=true \
                        --conf spark.driver.memoryOverhead=4g \
                        --conf spark.executor.memoryOverhead=4g \
                        --conf spark.yarn.maxAppAttempts=1 \
                        --queue root.das.apps.dea \
                        --driver-cores 4 \
                        --conf spark.driver.memory=30g \
                        --executor-memory 20g \
                        --conf spark.default.parallelism=200 \
                        --conf spark.sql.shuffle.partitions=200  \
                        --executor-cores 5 \
                        --num-executors 20  \
                        --py-files ${MERCHANT_ROOT_PATH}/utils/final_table/run_feature_generation.py \
                        --txn_snapshot_date '${SNAPSHOT_DATE}'
						--serve_or_train '${SERVE_OR_TRAIN}'
						--input_tables ${TBL_5_EXPLODE_MONTHLY} ${TBL_5_EXPLODE_WEEKLY} ${TBL_1D_ACCTMMHID_MONTHLY}
						--output_tables ${TBL_I_FEATURE_STORE} ${TBL_I_FEATURE_STORE_SERVING} ${TBL_I_FEATURE_STORE_LABEL}
						--region ${region}

[SQL_PARTITION_FEATURE_STORE]
ALTER TABLE ${DB_NAME}.${TBL_I_FEATURE_STORE}
    DROP IF EXISTS PARTITION
    (txn_snapshot_date <= to_date(months_sub(to_date('${SNAPSHOT_DATE}'), ${DATA_RETENTION})), region = '${REGION}');

[SQL_PARTITION_FEATURE_STORE_LABEL]
ALTER TABLE ${DB_NAME}.${TBL_I_FEATURE_STORE_LABEL}
    DROP IF EXISTS PARTITION
    (txn_snapshot_date <= to_date(months_sub(to_date('${SNAPSHOT_DATE}'), ${DATA_RETENTION})), region = '${REGION}');

[SQL_PARTITION_FEATURE_SERVING]
ALTER TABLE ${DB_NAME}.${TBL_I_FEATURE_STORE_SERVING}
    DROP IF EXISTS PARTITION
    (txn_snapshot_date <= to_date(days_add(to_date('${SNAPSHOT_DATE}'), -cast(${DATA_RETENTION} as int)*7)), region = '${REGION}');
